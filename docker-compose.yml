version: '3.8'

services:
  # MySQL Database Service
  mysql:
    image: mysql:8.0 # 使用 MySQL 8.0 官方镜像
    container_name: manuflex-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_password # ⚠️ 生产环境请使用更复杂的密码
      MYSQL_DATABASE: manuflex_paas # 数据库名称
      MYSQL_USER: manuflex_user # 数据库用户
      MYSQL_PASSWORD: manuflex_password # 数据库用户密码
    volumes:
      - mysql_data:/var/lib/mysql # 数据持久化
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql # 初始化 SQL 脚本 (可选，但推荐)
    healthcheck: # 健康检查
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - manuflex-network

  # Redis Cache Service
  redis:
    image: redis:7.0-alpine # 使用 Redis 7.0 Alpine 镜像，更小巧
    container_name: manuflex-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data # 数据持久化
    networks:
      - manuflex-network

  # Zookeeper Service (for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0 # 使用 Confluent 提供的 Zookeeper 镜像
    container_name: manuflex-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - manuflex-network

  # Kafka Broker Service
  kafka:
    image: confluentinc/cp-kafka:7.4.0 # 使用 Confluent 提供的 Kafka 镜像
    container_name: manuflex-kafka
    ports:
      - "9092:9092"
      - "9093:9093" # 用于内部通信，也可用于外部访问
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 # 连接到 Zookeeper 服务
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093 # Kafka 监听器配置
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT # 安全协议映射
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT # 内部通信监听器
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    depends_on:
      - zookeeper # 依赖 Zookeeper 启动
    networks:
      - manuflex-network

  nacos:
    image: nacos/nacos-server:v2.5.2 # ⬅️ 使用 Nacos Server 镜像，请选择一个稳定版本
    container_name: manuflex-nacos
    environment:
      # 单机模式启动
      MODE: standalone
      # 数据库配置 (Nacos 默认使用嵌入式 Derby，生产环境推荐外部 MySQL)
      # 如果希望使用外部 MySQL，需要配置 NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_EXPIRE_SECONDS, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_HEADER, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_SECRET_KEY, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_VALIDATE_INTERVAL_SECONDS
      # 并添加 MYSQL_MASTER_SERVICE_DB_URL, MYSQL_MASTER_SERVICE_DB_USER, MYSQL_MASTER_SERVICE_DB_PASSWORD
    ports:
      - "8848:8848" # Nacos 控制台和 API 端口
      - "9848:9848" # Nacos gRPC 端口
      - "9849:9849" # Nacos gRPC 端口 (可选)
    volumes:
      - nacos_data:/home/nacos/data # Nacos 数据持久化
      - ./docker/nacos/logs:/home/nacos/logs # Nacos 日志持久化
    networks:
      - manuflex-network
    healthcheck: # 健康检查
      test: [ "CMD", "curl", "-f", "http://localhost:8848/nacos/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  sentinel-dashboard:
    image: bladex/sentinel-dashboard:1.8.7 # ⬅️ 使用 Sentinel Dashboard 镜像，请选择一个稳定版本
    container_name: manuflex-sentinel-dashboard
    environment:
      # Sentinel Dashboard 端口
      SERVER_PORT: 8858 # Sentinel Dashboard 默认端口
      # JVM 启动参数 (可选)
      # JAVA_OPTS: -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard
    ports:
      - "8858:8858" # ⬅️ 映射 Sentinel Dashboard 端口，注意不要与 Gateway 端口冲突
    networks:
      - manuflex-network
    depends_on:
      - nacos # 依赖 Nacos 启动
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8858/dashboard/index.html" ]
      interval: 10s
      timeout: 5s
      retries: 5

  seata-server:
    image: seataio/seata-server:1.8.0.1
    container_name: manuflex-seata-server
    environment:
      # -------------------------------------------
      # 1. 基础配置
      # -------------------------------------------
      SERVER_PORT: 8091
      # 存储模式 (file/db/redis) - 注意：这是指 Seata 自身的 Session 存储
      STORE_MODE: file

      # -------------------------------------------
      # 2. 配置中心 (Config) - 读取 Seata 运行规则
      # -------------------------------------------
      SEATA_CONFIG_NAME: file:/root/seata-config/registry
      SEATA_CONFIG_TYPE: nacos
      # ⚠️ 关键修正：变量名必须是 SEATA_CONFIG_NACOS_...
      SEATA_CONFIG_NACOS_SERVER_ADDR: nacos:8848
      SEATA_CONFIG_NACOS_GROUP: SEATA_GROUP
      SEATA_CONFIG_NACOS_NAMESPACE: "" # 默认为空（即 public），不要填 "public" 字符串
      # 如果 Nacos 有账号密码
      SEATA_CONFIG_NACOS_USERNAME: nacos
      SEATA_CONFIG_NACOS_PASSWORD: nacos

      # -------------------------------------------
      # 3. 注册中心 (Registry) - 告诉别人我在哪
      # -------------------------------------------
      SEATA_REGISTRY_TYPE: nacos
      # ⚠️ 关键修正：变量名必须是 SEATA_REGISTRY_NACOS_...
      SEATA_REGISTRY_NACOS_SERVER_ADDR: nacos:8848
      SEATA_REGISTRY_NACOS_GROUP: SEATA_GROUP
      SEATA_REGISTRY_NACOS_NAMESPACE: ""
      SEATA_REGISTRY_NACOS_USERNAME: nacos
      SEATA_REGISTRY_NACOS_PASSWORD: nacos

    ports:
      - "8091:8091"
    networks:
      - manuflex-network
    depends_on:
      nacos:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8091/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  zipkin:
    image: openzipkin/zipkin:3
    container_name: manuflex-zipkin
    environment:
      - STORAGE_TYPE=mem # 开发环境存内存，重启丢失。生产建议用 elasticsearch
    ports:
      - "9411:9411"
    networks:
      - manuflex-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9411/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql_data:
  redis_data:
  nacos_data:
  sentinel_dashboard_data:
  seata_server_data:
  zipkin_data:

networks:
  manuflex-network:
    driver: bridge
