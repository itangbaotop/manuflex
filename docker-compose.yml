version: '3.8'

services:
  # MySQL Database Service
  mysql:
    image: mysql:8.0 # ä½¿ç”¨ MySQL 8.0 å®˜æ–¹é•œåƒ
    container_name: manuflex-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_password # âš ï¸ ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç 
      MYSQL_DATABASE: manuflex_paas # æ•°æ®åº“åç§°
      MYSQL_USER: manuflex_user # æ•°æ®åº“ç”¨æˆ·
      MYSQL_PASSWORD: manuflex_password # æ•°æ®åº“ç”¨æˆ·å¯†ç 
    volumes:
      - mysql_data:/var/lib/mysql # æ•°æ®æŒä¹…åŒ–
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql # åˆå§‹åŒ– SQL è„šæœ¬ (å¯é€‰ï¼Œä½†æ¨è)
    healthcheck: # å¥åº·æ£€æŸ¥
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - manuflex-network

  # Redis Cache Service
  redis:
    image: redis:7.0-alpine # ä½¿ç”¨ Redis 7.0 Alpine é•œåƒï¼Œæ›´å°å·§
    container_name: manuflex-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data # æ•°æ®æŒä¹…åŒ–
    networks:
      - manuflex-network

  # Zookeeper Service (for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0 # ä½¿ç”¨ Confluent æä¾›çš„ Zookeeper é•œåƒ
    container_name: manuflex-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - manuflex-network

  # Kafka Broker Service
  kafka:
    image: confluentinc/cp-kafka:7.4.0 # ä½¿ç”¨ Confluent æä¾›çš„ Kafka é•œåƒ
    container_name: manuflex-kafka
    ports:
      - "9092:9092"
      - "9093:9093" # ç”¨äºå†…éƒ¨é€šä¿¡ï¼Œä¹Ÿå¯ç”¨äºå¤–éƒ¨è®¿é—®
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 # è¿æ¥åˆ° Zookeeper æœåŠ¡
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093 # Kafka ç›‘å¬å™¨é…ç½®
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT # å®‰å…¨åè®®æ˜ å°„
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT # å†…éƒ¨é€šä¿¡ç›‘å¬å™¨
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    depends_on:
      - zookeeper # ä¾èµ– Zookeeper å¯åŠ¨
    networks:
      - manuflex-network

  nacos:
    image: nacos/nacos-server:v2.5.2 # â¬…ï¸ ä½¿ç”¨ Nacos Server é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-nacos
    environment:
      # å•æœºæ¨¡å¼å¯åŠ¨
      - MODE=standalone
        # ğŸ‘‡ æ–°å¢ï¼šå¼ºåˆ¶æš´éœ² Prometheus å’Œ Health ç«¯ç‚¹
      - "JAVA_TOOL_OPTIONS=-Dmanagement.endpoints.web.exposure.include=*"
      # æ•°æ®åº“é…ç½® (Nacos é»˜è®¤ä½¿ç”¨åµŒå…¥å¼ Derbyï¼Œç”Ÿäº§ç¯å¢ƒæ¨èå¤–éƒ¨ MySQL)
      # å¦‚æœå¸Œæœ›ä½¿ç”¨å¤–éƒ¨ MySQLï¼Œéœ€è¦é…ç½® NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_EXPIRE_SECONDS, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_HEADER, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_SECRET_KEY, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_VALIDATE_INTERVAL_SECONDS
      # å¹¶æ·»åŠ  MYSQL_MASTER_SERVICE_DB_URL, MYSQL_MASTER_SERVICE_DB_USER, MYSQL_MASTER_SERVICE_DB_PASSWORD
    ports:
      - "8848:8848" # Nacos æ§åˆ¶å°å’Œ API ç«¯å£
      - "9848:9848" # Nacos gRPC ç«¯å£
      - "9849:9849" # Nacos gRPC ç«¯å£ (å¯é€‰)
    volumes:
      - nacos_data:/home/nacos/data # Nacos æ•°æ®æŒä¹…åŒ–
      - ./docker/nacos/logs:/home/nacos/logs # Nacos æ—¥å¿—æŒä¹…åŒ–
    networks:
      - manuflex-network
    healthcheck: # å¥åº·æ£€æŸ¥
      test: [ "CMD", "curl", "-f", "http://localhost:8848/nacos/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  sentinel-dashboard:
    image: bladex/sentinel-dashboard:1.8.7 # â¬…ï¸ ä½¿ç”¨ Sentinel Dashboard é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-sentinel-dashboard
    environment:
      # Sentinel Dashboard ç«¯å£
      SERVER_PORT: 8858 # Sentinel Dashboard é»˜è®¤ç«¯å£
      # JVM å¯åŠ¨å‚æ•° (å¯é€‰)
      # JAVA_OPTS: -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard
    ports:
      - "8858:8858" # â¬…ï¸ æ˜ å°„ Sentinel Dashboard ç«¯å£ï¼Œæ³¨æ„ä¸è¦ä¸ Gateway ç«¯å£å†²çª
    networks:
      - manuflex-network
    depends_on:
      - nacos # ä¾èµ– Nacos å¯åŠ¨
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8858/dashboard/index.html" ]
      interval: 10s
      timeout: 5s
      retries: 5

  seata-server:
    image: seataio/seata-server:1.8.0.1
    container_name: manuflex-seata-server
    environment:
      # -------------------------------------------
      # 1. åŸºç¡€é…ç½®
      # -------------------------------------------
      SERVER_PORT: 8091
      # å­˜å‚¨æ¨¡å¼ (file/db/redis) - æ³¨æ„ï¼šè¿™æ˜¯æŒ‡ Seata è‡ªèº«çš„ Session å­˜å‚¨
      STORE_MODE: file

      # -------------------------------------------
      # 2. é…ç½®ä¸­å¿ƒ (Config) - è¯»å– Seata è¿è¡Œè§„åˆ™
      # -------------------------------------------
      SEATA_CONFIG_NAME: file:/root/seata-config/registry
      SEATA_CONFIG_TYPE: nacos
      # âš ï¸ å…³é”®ä¿®æ­£ï¼šå˜é‡åå¿…é¡»æ˜¯ SEATA_CONFIG_NACOS_...
      SEATA_CONFIG_NACOS_SERVER_ADDR: nacos:8848
      SEATA_CONFIG_NACOS_GROUP: SEATA_GROUP
      SEATA_CONFIG_NACOS_NAMESPACE: "" # é»˜è®¤ä¸ºç©ºï¼ˆå³ publicï¼‰ï¼Œä¸è¦å¡« "public" å­—ç¬¦ä¸²
      # å¦‚æœ Nacos æœ‰è´¦å·å¯†ç 
      SEATA_CONFIG_NACOS_USERNAME: nacos
      SEATA_CONFIG_NACOS_PASSWORD: nacos

      # -------------------------------------------
      # 3. æ³¨å†Œä¸­å¿ƒ (Registry) - å‘Šè¯‰åˆ«äººæˆ‘åœ¨å“ª
      # -------------------------------------------
      SEATA_REGISTRY_TYPE: nacos
      # âš ï¸ å…³é”®ä¿®æ­£ï¼šå˜é‡åå¿…é¡»æ˜¯ SEATA_REGISTRY_NACOS_...
      SEATA_REGISTRY_NACOS_SERVER_ADDR: nacos:8848
      SEATA_REGISTRY_NACOS_GROUP: SEATA_GROUP
      SEATA_REGISTRY_NACOS_NAMESPACE: ""
      SEATA_REGISTRY_NACOS_USERNAME: nacos
      SEATA_REGISTRY_NACOS_PASSWORD: nacos
      SEATA_METRICS_ENABLED: "true"

    ports:
      - "8091:8091"
    networks:
      - manuflex-network
    depends_on:
      nacos:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8091/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  zipkin:
    image: openzipkin/zipkin:3
    container_name: manuflex-zipkin
    environment:
      - STORAGE_TYPE=mem # å¼€å‘ç¯å¢ƒå­˜å†…å­˜ï¼Œé‡å¯ä¸¢å¤±ã€‚ç”Ÿäº§å»ºè®®ç”¨ elasticsearch
    ports:
      - "9411:9411"
    networks:
      - manuflex-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9411/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:v3.7.0
    container_name: manuflex-prometheus
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml # â¬…ï¸ Prometheus é…ç½®
      - prometheus_data:/prometheus # Prometheus æ•°æ®æŒä¹…åŒ–
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090" # Prometheus UI ç«¯å£
    networks:
      - manuflex-network
    depends_on:
      - nacos # Prometheus å¯ä»¥ä» Nacos å‘ç°å¾®æœåŠ¡ï¼Œä½†è¿™é‡Œæˆ‘ä»¬é€šè¿‡é™æ€é…ç½®
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9090/-/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:12.1 # â¬…ï¸ ä½¿ç”¨ Grafana é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-grafana
    volumes:
      - grafana_data:/var/lib/grafana # Grafana æ•°æ®æŒä¹…åŒ–
      - ./docker/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources # â¬…ï¸ Grafana é…ç½®
    environment:
      GF_SECURITY_ADMIN_USER: admin # Grafana é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·å
      GF_SECURITY_ADMIN_PASSWORD: admin # Grafana é»˜è®¤ç®¡ç†å‘˜å¯†ç 
    ports:
      - "3001:3000" # â¬…ï¸ Grafana UI ç«¯å£ï¼Œæ³¨æ„ä¸è¦ä¸å‰ç«¯åº”ç”¨ç«¯å£å†²çª
    networks:
      - manuflex-network
    depends_on:
      - prometheus
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql_data:
  redis_data:
  nacos_data:
  sentinel_dashboard_data:
  seata_server_data:
  zipkin_data:
  prometheus_data:
  grafana_data:

networks:
  manuflex-network:
    driver: bridge
