version: '3.8'

services:
  # MySQL Database Service
  mysql:
    image: mysql:8.0 # ä½¿ç”¨ MySQL 8.0 å®˜æ–¹é•œåƒ
    container_name: manuflex-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_password # âš ï¸ ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç 
      MYSQL_DATABASE: manuflex_paas # æ•°æ®åº“åç§°
      MYSQL_USER: manuflex_user # æ•°æ®åº“ç”¨æˆ·
      MYSQL_PASSWORD: manuflex_password # æ•°æ®åº“ç”¨æˆ·å¯†ç 
    volumes:
      - mysql_data:/var/lib/mysql # æ•°æ®æŒä¹…åŒ–
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql # åˆå§‹åŒ– SQL è„šæœ¬ (å¯é€‰ï¼Œä½†æ¨è)
    healthcheck: # å¥åº·æ£€æŸ¥
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - manuflex-network

  # Redis Cache Service
  redis:
    image: redis:7.0-alpine # ä½¿ç”¨ Redis 7.0 Alpine é•œåƒï¼Œæ›´å°å·§
    container_name: manuflex-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data # æ•°æ®æŒä¹…åŒ–
    networks:
      - manuflex-network

  # Zookeeper Service (for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0 # ä½¿ç”¨ Confluent æä¾›çš„ Zookeeper é•œåƒ
    container_name: manuflex-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - manuflex-network

  # Kafka Broker Service
  kafka:
    image: confluentinc/cp-kafka:7.4.0 # ä½¿ç”¨ Confluent æä¾›çš„ Kafka é•œåƒ
    container_name: manuflex-kafka
    ports:
      - "9092:9092"
      - "9093:9093" # ç”¨äºå†…éƒ¨é€šä¿¡ï¼Œä¹Ÿå¯ç”¨äºå¤–éƒ¨è®¿é—®
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 # è¿æ¥åˆ° Zookeeper æœåŠ¡
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093 # Kafka ç›‘å¬å™¨é…ç½®
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT # å®‰å…¨åè®®æ˜ å°„
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT # å†…éƒ¨é€šä¿¡ç›‘å¬å™¨
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    depends_on:
      - zookeeper # ä¾èµ– Zookeeper å¯åŠ¨
    networks:
      - manuflex-network

  nacos:
    image: nacos/nacos-server:v2.5.2 #  ä½¿ç”¨ Nacos Server é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-nacos
    environment:
      # å•æœºæ¨¡å¼å¯åŠ¨
      - MODE=standalone
      # ğŸ‘‡ æ–°å¢ï¼šå¼ºåˆ¶æš´éœ² Prometheus å’Œ Health ç«¯ç‚¹
      - "JAVA_TOOL_OPTIONS=-Dmanagement.endpoints.web.exposure.include=*"
      # æ•°æ®åº“é…ç½® (Nacos é»˜è®¤ä½¿ç”¨åµŒå…¥å¼ Derbyï¼Œç”Ÿäº§ç¯å¢ƒæ¨èå¤–éƒ¨ MySQL)
      # å¦‚æœå¸Œæœ›ä½¿ç”¨å¤–éƒ¨ MySQLï¼Œéœ€è¦é…ç½® NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_EXPIRE_SECONDS, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_HEADER, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_SECRET_KEY, NACOS_AUTH_PLUGIN_Nacos_AUTH_TOKEN_VALIDATE_INTERVAL_SECONDS
      # å¹¶æ·»åŠ  MYSQL_MASTER_SERVICE_DB_URL, MYSQL_MASTER_SERVICE_DB_USER, MYSQL_MASTER_SERVICE_DB_PASSWORD
    ports:
      - "8848:8848" # Nacos æ§åˆ¶å°å’Œ API ç«¯å£
      - "9848:9848" # Nacos gRPC ç«¯å£
      - "9849:9849" # Nacos gRPC ç«¯å£ (å¯é€‰)
    volumes:
      - nacos_data:/home/nacos/data # Nacos æ•°æ®æŒä¹…åŒ–
      - ./docker/nacos/logs:/home/nacos/logs # Nacos æ—¥å¿—æŒä¹…åŒ–
    networks:
      - manuflex-network
    healthcheck: # å¥åº·æ£€æŸ¥
      test: [ "CMD", "curl", "-f", "http://localhost:8848/nacos/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  sentinel-dashboard:
    image: bladex/sentinel-dashboard:1.8.7 #  ä½¿ç”¨ Sentinel Dashboard é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-sentinel-dashboard
    profiles: [ monitoring ]
    environment:
      # Sentinel Dashboard ç«¯å£
      SERVER_PORT: 8858 # Sentinel Dashboard é»˜è®¤ç«¯å£
      # JVM å¯åŠ¨å‚æ•° (å¯é€‰)
      # JAVA_OPTS: -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard
    ports:
      - "8858:8858" #  æ˜ å°„ Sentinel Dashboard ç«¯å£ï¼Œæ³¨æ„ä¸è¦ä¸ Gateway ç«¯å£å†²çª
    networks:
      - manuflex-network
    depends_on:
      - nacos # ä¾èµ– Nacos å¯åŠ¨
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8858/dashboard/index.html" ]
      interval: 10s
      timeout: 5s
      retries: 5

  seata-server:
    image: seataio/seata-server:2.0.0.jre17 #  æŒ‡å®šæ‚¨è¦æ±‚çš„ JRE 17 ç‰ˆæœ¬é•œåƒ
    container_name: manuflex-seata-server
    hostname: seata-server
    profiles: [ monitoring ]
    environment:
      # ---------------------------------------------------------
      # 1. ç½‘ç»œæ ¸å¿ƒé…ç½® (è§£å†³ Windows + WSL 2 è¿æ¥é—®é¢˜)
      # ---------------------------------------------------------
      - SEATA_IP=192.168.1.52 # å¼ºåˆ¶æ³¨å†Œ IP ä¸º 127.0.0.1 (åˆ©ç”¨ WSL è‡ªåŠ¨è½¬å‘)
      - SEATA_PORT=8091           # å¼ºåˆ¶æ³¨å†Œ RPC ç«¯å£

      # ---------------------------------------------------------
      # 2. ç«¯å£åˆ†ç¦» (è§£å†³ "Address already in use" æŠ¥é”™)
      # ---------------------------------------------------------
      - SERVER_PORT=7091          # å°† Web æ§åˆ¶å°ç§»åˆ° 7091ï¼ŒæŠŠ 8091 è®©ç»™ RPC

      # ---------------------------------------------------------
      # 3. åŸºç¡€æ¨¡å¼é…ç½®
      # ---------------------------------------------------------
      - STORE_MODE=file           # å­˜å‚¨æ¨¡å¼
      - SEATA_CONSOLE_SECURITY_ENABLED=false # å…³é—­ç™»å½•ï¼Œé¿å… Prometheus ç›‘æ§æŠ¥é”™

      # ---------------------------------------------------------
      # 4. Nacos æ³¨å†Œä¸­å¿ƒ & é…ç½®ä¸­å¿ƒ
      # ---------------------------------------------------------
      - SEATA_CONFIG_NAME=file:/root/seata-config/registry # âš ï¸ å¦‚æœæ²¡æŒ‚è½½æ–‡ä»¶ï¼Œè¯·åˆ é™¤æ­¤è¡Œï¼Œå¦åˆ™ä¼šå¿½ç•¥ç¯å¢ƒå˜é‡
      # å»ºè®®ç›´æ¥ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½® Nacosï¼Œæ›´ç¨³å®šï¼š
      - SEATA_CONFIG_TYPE=nacos
      - SEATA_CONFIG_NACOS_SERVER_ADDR=nacos:8848
      - SEATA_CONFIG_NACOS_GROUP=SEATA_GROUP
      - SEATA_CONFIG_NACOS_NAMESPACE=

      - SEATA_REGISTRY_TYPE=nacos
      - SEATA_REGISTRY_NACOS_SERVER_ADDR=nacos:8848
      - SEATA_REGISTRY_NACOS_GROUP=SEATA_GROUP
      - SEATA_REGISTRY_NACOS_NAMESPACE=

      # ---------------------------------------------------------
      # 5. JVM å‚æ•° (åŒé‡ä¿é™©ï¼Œé˜²æ­¢å¯åŠ¨è„šæœ¬å¿½ç•¥ SEATA_IP)
      # ---------------------------------------------------------
      # æ³¨æ„ï¼šseataio é•œåƒé€šå¸¸æ”¯æŒ JVM_OPTS
      - JVM_OPTS=-Dseata.ip=192.168.1.52 -Dseata.service.vgroupMapping.manuflex_tx_group=default

    ports:
      - "8091:8091" # æ˜ å°„ RPC ç«¯å£ (Java ä»£ç è¿æ¥ç”¨)
      - "7091:7091" # æ˜ å°„ Web ç«¯å£ (æµè§ˆå™¨æ§åˆ¶å°ç”¨)
    networks:
      - manuflex-network
    volumes:
      - ./seata-logs:/root/logs/seata
    depends_on:
      nacos:
        condition: service_healthy
    healthcheck:
      # æ³¨æ„ï¼šå¥åº·æ£€æŸ¥è¦è®¿é—® Web ç«¯å£ 7091
      test: [ "CMD", "curl", "-f", "http://localhost:7091/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  zipkin:
    image: openzipkin/zipkin:3
    container_name: manuflex-zipkin
    profiles: [ monitoring ]
    environment:
      - STORAGE_TYPE=mem # å¼€å‘ç¯å¢ƒå­˜å†…å­˜ï¼Œé‡å¯ä¸¢å¤±ã€‚ç”Ÿäº§å»ºè®®ç”¨ elasticsearch
    ports:
      - "9411:9411"
    networks:
      - manuflex-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9411/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:v3.7.0
    container_name: manuflex-prometheus
    profiles: [ monitoring ]
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml #  Prometheus é…ç½®
      - prometheus_data:/prometheus # Prometheus æ•°æ®æŒä¹…åŒ–
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090" # Prometheus UI ç«¯å£
    networks:
      - manuflex-network
    depends_on:
      - nacos # Prometheus å¯ä»¥ä» Nacos å‘ç°å¾®æœåŠ¡ï¼Œä½†è¿™é‡Œæˆ‘ä»¬é€šè¿‡é™æ€é…ç½®
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9090/-/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:12.1 #  ä½¿ç”¨ Grafana é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-grafana
    profiles: [ monitoring ]
    volumes:
      - grafana_data:/var/lib/grafana # Grafana æ•°æ®æŒä¹…åŒ–
      - ./docker/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources #  Grafana é…ç½®
    environment:
      GF_SECURITY_ADMIN_USER: admin # Grafana é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·å
      GF_SECURITY_ADMIN_PASSWORD: admin # Grafana é»˜è®¤ç®¡ç†å‘˜å¯†ç 
    ports:
      - "3001:3000" #  Grafana UI ç«¯å£ï¼Œæ³¨æ„ä¸è¦ä¸å‰ç«¯åº”ç”¨ç«¯å£å†²çª
    networks:
      - manuflex-network
    depends_on:
      - prometheus
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  loki:
    image: grafana/loki:2.9.2 #  ä½¿ç”¨ Loki é•œåƒï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-loki
    profiles: [ monitoring ]
    ports:
      - "3100:3100" # Loki API ç«¯å£
    command: -config.file=/etc/loki/local-config.yaml #  æŒ‡å®š Loki é…ç½®æ–‡ä»¶
    volumes:
      - ./docker/loki/local-config.yaml:/etc/loki/local-config.yaml #  Loki é…ç½®æ–‡ä»¶
      - loki_data:/loki # Loki æ•°æ®æŒä¹…åŒ–
    networks:
      - manuflex-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3100/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5

    # Promtail Log Collector (æ–°å¢)
  promtail:
    image: grafana/promtail:2.9.2 #  ä½¿ç”¨ Promtail é•œåƒï¼Œä¸ Loki ç‰ˆæœ¬ä¸€è‡´
    container_name: manuflex-promtail
    profiles: [ monitoring ]
    volumes:
      - ./docker/promtail/config.yaml:/etc/promtail/config.yaml #  Promtail é…ç½®æ–‡ä»¶
      - /var/log:/var/log #  æ˜ å°„ä¸»æœºçš„ /var/log ç›®å½• (æˆ–æ‚¨å¾®æœåŠ¡æ—¥å¿—æ‰€åœ¨çš„ç›®å½•)
      #  å…³é”®ï¼šæ˜ å°„ Java å¾®æœåŠ¡æ—¥å¿—æ‰€åœ¨çš„ç›®å½•
      - ./logs/iam:/app/logs/iam:ro # å‡è®¾ IAM æœåŠ¡æ—¥å¿—åœ¨ ./logs/iam
      - ./logs/metadata:/app/logs/metadata:ro
      - ./logs/data:/app/logs/data:ro
      - ./logs/lims:/app/logs/lims:ro
      - ./logs/workflow:/app/logs/workflow:ro
      - ./logs/gateway:/app/logs/gateway:ro
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - manuflex-network
    depends_on:
      - loki
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9080/ready" ] # Promtail é»˜è®¤ç›‘å¬ 9080 ç«¯å£
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2024-01-18T22-51-28Z # æ¨èå›ºå®šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    container_name: manuflex-minio
    ports:
      - "9000:9000" # API ç«¯å£
      - "9001:9001" # Console æ§åˆ¶å°ç«¯å£
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadminpassword
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - manuflex-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3


  # 1. API ç½‘å…³ (å…¥å£)
  platform-api-gateway:
    build: ./platform-api-gateway
    container_name: manuflex-gateway
    ports:
      - "8080:8080" # åªæš´éœ²ç½‘å…³ç«¯å£ç»™å®¿ä¸»æœº
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c
#      # å¼ºåˆ¶æŒ‡å®š Nacos åœ°å€ä¸ºå®¹å™¨å
#      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
#      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
    depends_on:
      - nacos
    #      - redis
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

  # 2. IAM æœåŠ¡
  platform-iam-service:
    build: ./platform-iam-service
    container_name: manuflex-iam
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c
    depends_on:
      - nacos
      - mysql
    #      - redis
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

  # 3. Metadata æœåŠ¡
  platform-metadata-service:
    build: ./platform-metadata-service
    container_name: manuflex-metadata
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c
    depends_on:
      - nacos
      - mysql
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

  # 4. Data æœåŠ¡
  platform-data-service:
    build: ./platform-data-service
    container_name: manuflex-data
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c
    depends_on:
      - nacos
      - mysql
      - platform-metadata-service # ä¾èµ– Metadata
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

  # 5. Workflow æœåŠ¡
  platform-workflow-service:
    build: ./platform-workflow-service
    container_name: manuflex-workflow
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c
    depends_on:
      - nacos
      - mysql
      - kafka
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

  # 6. LIMS æœåŠ¡ (å¯é€‰ï¼Œå¦‚æœä¸æƒ³è·‘å¯ä»¥æ³¨é‡Šæ‰)
  platform-lims-service:
    build: ./platform-lims-service
    container_name: manuflex-lims
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c
    depends_on:
      - nacos
      - platform-data-service
      - platform-workflow-service
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

  # 7. æ–‡ä»¶æœåŠ¡ (File Service)
  platform-file-service:
    build: ./platform-file-service
    container_name: manuflex-file
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_HOST=nacos
      - NACOS_NAMESPACE=b6c61ff5-0ec0-4a3b-8529-4f110619308c # ä¿æŒä¸å…¶ä»–æœåŠ¡ä¸€è‡´
      # å¦‚æœ MinIO ä¹Ÿåœ¨ Docker ç½‘ç»œä¸­ï¼Œè¿™é‡Œé€šå¸¸ä¸éœ€è¦é¢å¤–é…ç½®ï¼Œ
      # å› ä¸º application.yml é‡Œ minio.endpoint é…çš„æ˜¯ http://${MINIO_HOST:minio}:9000
      # åªéœ€è¦ç¡®ä¿ä¸‹é¢ depends_on é‡Œæœ‰ minio
    depends_on:
      - nacos
      - minio # ç¡®ä¿ MinIO å…ˆå¯åŠ¨
    networks:
      - manuflex-network
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  mysql_data:
  redis_data:
  nacos_data:
  sentinel_dashboard_data:
  seata_server_data:
  zipkin_data:
  prometheus_data:
  grafana_data:
  loki_data:
  minio_data:

networks:
  manuflex-network:
    driver: bridge


#  docker-compose up -d mysql nacos kafka platform-api-gateway platform-iam-service platform-metadata-service platform-data-service platform-workflow-service platform-lims-service
#  docker-compose up -d --build --no-deps platform-api-gateway platform-iam-service platform-metadata-service platform-data-service platform-workflow-service platform-file-service

## 1. åœæ­¢å¹¶åˆ é™¤æ—§çš„ IAM å®¹å™¨
#  docker stop manuflex-data
#
#  docker rm manuflex-data
#  # 2. åˆ é™¤æ—§é•œåƒ (å¯é€‰ï¼Œä½†æ¨è)
#  docker rmi manuflex_platform-data-service
#
#  # 3. å†æ¬¡å°è¯•å¯åŠ¨
#  docker-compose up -d --build --no-deps platform-data-service